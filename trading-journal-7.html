<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Journal</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0a0c; --bg-secondary: #111114; --bg-card: #161619; --bg-hover: #1c1c20;
            --border: #252529; --text-primary: #f4f4f5; --text-secondary: #a1a1aa; --text-muted: #71717a;
            --green: #22c55e; --green-dim: rgba(34, 197, 94, 0.12);
            --red: #ef4444; --red-dim: rgba(239, 68, 68, 0.12);
            --blue: #3b82f6; --blue-dim: rgba(59, 130, 246, 0.12);
            --yellow: #eab308; --yellow-dim: rgba(234, 179, 8, 0.12);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Space Grotesk', sans-serif; background: var(--bg-primary); color: var(--text-primary); min-height: 100vh; line-height: 1.5; }
        .container { max-width: 1200px; margin: 0 auto; padding: 32px 20px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px; flex-wrap: wrap; gap: 16px; }
        .logo { font-size: 24px; font-weight: 700; display: flex; align-items: center; gap: 12px; }
        .logo-icon { width: 40px; height: 40px; background: linear-gradient(135deg, var(--green), var(--blue)); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 20px; }
        .header-actions { display: flex; gap: 12px; align-items: center; }
        .sync-status { font-size: 13px; color: var(--text-muted); display: flex; align-items: center; gap: 6px; }
        .sync-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--text-muted); }
        .sync-dot.connected { background: var(--green); }
        .sync-dot.syncing { background: var(--yellow); animation: pulse 1s infinite; }
        .sync-dot.error { background: var(--red); }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
        .btn { padding: 10px 18px; border-radius: 8px; font-size: 14px; font-weight: 500; cursor: pointer; border: none; transition: all 0.2s; font-family: inherit; }
        .btn-primary { background: var(--green); color: #000; }
        .btn-primary:hover { background: #16a34a; }
        .btn-secondary { background: var(--bg-card); color: var(--text-primary); border: 1px solid var(--border); }
        .btn-secondary:hover { background: var(--bg-hover); }
        .btn-icon { width: 40px; height: 40px; padding: 0; display: flex; align-items: center; justify-content: center; font-size: 18px; }
        .setup-banner { background: linear-gradient(135deg, var(--blue-dim), rgba(168,85,247,0.2)); border: 1px solid var(--blue); border-radius: 12px; padding: 20px; margin-bottom: 24px; display: none; }
        .setup-banner.active { display: block; }
        .setup-banner h3 { font-size: 16px; margin-bottom: 8px; }
        .setup-banner p { color: var(--text-secondary); font-size: 14px; margin-bottom: 16px; }
        .setup-form { display: flex; gap: 12px; }
        .setup-form input { flex: 1; padding: 10px 14px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-primary); color: var(--text-primary); font-size: 14px; font-family: 'JetBrains Mono', monospace; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 12px; margin-bottom: 32px; }
        .stat-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 16px; }
        .stat-label { font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px; }
        .stat-value { font-size: 24px; font-weight: 600; font-family: 'JetBrains Mono', monospace; }
        .stat-value.positive { color: var(--green); }
        .stat-value.negative { color: var(--red); }
        .tabs { display: flex; gap: 4px; margin-bottom: 24px; background: var(--bg-secondary); padding: 4px; border-radius: 10px; width: fit-content; flex-wrap: wrap; }
        .tab { padding: 10px 16px; border-radius: 8px; font-size: 14px; font-weight: 500; cursor: pointer; color: var(--text-secondary); background: transparent; border: none; transition: all 0.2s; }
        .tab.active { background: var(--bg-card); color: var(--text-primary); }
        .tab:hover:not(.active) { color: var(--text-primary); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .table-container { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 14px 16px; text-align: left; font-size: 14px; }
        th { background: var(--bg-secondary); color: var(--text-muted); font-weight: 500; text-transform: uppercase; font-size: 11px; }
        tr:not(:last-child) td { border-bottom: 1px solid var(--border); }
        tr:hover td { background: var(--bg-hover); }
        .ticker { font-weight: 600; font-family: 'JetBrains Mono', monospace; }
        .direction { display: inline-block; padding: 4px 10px; border-radius: 6px; font-size: 12px; font-weight: 500; }
        .direction.long { background: var(--green-dim); color: var(--green); }
        .direction.short { background: var(--red-dim); color: var(--red); }
        .status { padding: 4px 10px; border-radius: 6px; font-size: 12px; font-weight: 500; }
        .status.open { background: var(--yellow-dim); color: var(--yellow); }
        .status.partial { background: var(--blue-dim); color: var(--blue); }
        .status.closed { background: var(--green-dim); color: var(--green); }
        .status.stopped { background: var(--red-dim); color: var(--red); }
        .pnl { font-family: 'JetBrains Mono', monospace; font-weight: 500; }
        .pnl.positive { color: var(--green); }
        .pnl.negative { color: var(--red); }
        .actions { display: flex; gap: 8px; }
        .action-btn { width: 32px; height: 32px; border-radius: 6px; border: none; background: var(--bg-secondary); color: var(--text-secondary); cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .action-btn:hover { background: var(--bg-hover); color: var(--text-primary); }
        .action-btn.delete:hover { background: var(--red-dim); color: var(--red); }
        .empty-state { text-align: center; padding: 60px 20px; color: var(--text-muted); }
        .empty-state-icon { font-size: 48px; margin-bottom: 16px; }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: none; align-items: center; justify-content: center; z-index: 100; padding: 20px; }
        .modal-overlay.active { display: flex; }
        .modal { background: var(--bg-card); border: 1px solid var(--border); border-radius: 16px; width: 100%; max-width: 480px; max-height: 90vh; overflow-y: auto; }
        .modal-header { padding: 20px 24px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .modal-header h2 { font-size: 18px; font-weight: 600; }
        .modal-close { width: 32px; height: 32px; border-radius: 8px; border: none; background: transparent; color: var(--text-secondary); cursor: pointer; font-size: 20px; }
        .modal-body { padding: 24px; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; font-size: 13px; color: var(--text-secondary); margin-bottom: 8px; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px 14px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-primary); color: var(--text-primary); font-size: 14px; font-family: inherit; }
        .form-group textarea { resize: vertical; min-height: 80px; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .form-actions { display: flex; gap: 12px; padding-top: 8px; }
        .form-actions .btn { flex: 1; }
        .autocomplete-wrapper { position: relative; }
        .autocomplete-dropdown { position: absolute; top: 100%; left: 0; right: 0; background: var(--bg-primary); border: 1px solid var(--border); border-radius: 8px; margin-top: 4px; max-height: 200px; overflow-y: auto; z-index: 1000; display: none; }
        .autocomplete-dropdown.active { display: block; }
        .autocomplete-item { padding: 10px 14px; cursor: pointer; display: flex; justify-content: space-between; border-bottom: 1px solid var(--border); }
        .autocomplete-item:hover { background: var(--bg-hover); }
        .autocomplete-ticker { font-weight: 600; font-family: 'JetBrains Mono', monospace; }
        .autocomplete-name { font-size: 12px; color: var(--text-muted); }
        .autocomplete-loading { padding: 12px; text-align: center; color: var(--text-muted); }
        .risk-calculator { background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 10px; padding: 14px; margin-bottom: 20px; }
        .risk-row { display: flex; gap: 12px; }
        .risk-item { flex: 1; text-align: center; padding: 8px; border-radius: 8px; }
        .risk-item.loss { background: var(--red-dim); }
        .risk-item.profit { background: var(--green-dim); }
        .risk-item.ratio { background: var(--blue-dim); }
        .risk-label { display: block; font-size: 11px; color: var(--text-muted); margin-bottom: 4px; text-transform: uppercase; }
        .risk-value { font-family: 'JetBrains Mono', monospace; font-size: 14px; font-weight: 600; }
        .risk-item.loss .risk-value { color: var(--red); }
        .risk-item.profit .risk-value { color: var(--green); }
        .risk-item.ratio .risk-value { color: var(--blue); }
        .exit-fields { border-top: 1px solid var(--border); padding-top: 20px; margin-top: 8px; }
        .current-price-display { display: flex; align-items: center; gap: 8px; padding: 12px 14px; background: var(--bg-primary); border: 1px solid var(--border); border-radius: 8px; }
        .current-price-value { font-family: 'JetBrains Mono', monospace; font-size: 16px; font-weight: 600; }
        .current-price-change { font-family: 'JetBrains Mono', monospace; font-size: 12px; padding: 2px 6px; border-radius: 4px; }
        .current-price-change.up { color: var(--green); background: var(--green-dim); }
        .current-price-change.down { color: var(--red); background: var(--red-dim); }
        .refresh-btn { margin-left: auto; background: none; border: none; cursor: pointer; font-size: 14px; opacity: 0.6; }
        .refresh-btn:hover { opacity: 1; }
        .stats-section { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 24px; margin-bottom: 20px; }
        .stats-title { font-size: 16px; font-weight: 600; margin-bottom: 20px; }
        .monthly-stats { display: flex; flex-direction: column; gap: 8px; }
        .month-row { display: flex; align-items: center; padding: 12px 16px; background: var(--bg-secondary); border-radius: 8px; gap: 16px; }
        .month-name { width: 100px; font-weight: 500; color: var(--text-secondary); }
        .month-bar-container { flex: 1; height: 24px; background: var(--bg-primary); border-radius: 4px; overflow: hidden; }
        .month-bar { height: 100%; border-radius: 4px; }
        .month-bar.positive { background: linear-gradient(90deg, var(--green-dim), var(--green)); }
        .month-bar.negative { background: linear-gradient(90deg, var(--red), var(--red-dim)); float: right; }
        .month-value { width: 90px; text-align: right; font-family: 'JetBrains Mono', monospace; font-weight: 600; }
        .month-value.positive { color: var(--green); }
        .month-value.negative { color: var(--red); }
        .month-trades { width: 60px; text-align: center; font-size: 12px; color: var(--text-muted); }
        .overall-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 16px; }
        .overall-stat-card { background: var(--bg-secondary); border-radius: 10px; padding: 16px; text-align: center; }
        .overall-stat-label { font-size: 12px; color: var(--text-muted); text-transform: uppercase; margin-bottom: 8px; }
        .overall-stat-value { font-size: 24px; font-weight: 600; font-family: 'JetBrains Mono', monospace; }
        .overall-stat-value.positive { color: var(--green); }
        .overall-stat-value.negative { color: var(--red); }
        .no-stats { text-align: center; padding: 40px; color: var(--text-muted); }
        .price-change { font-size: 12px; margin-left: 8px; }
        .price-change.up { color: var(--green); }
        .price-change.down { color: var(--red); }
        .level { font-family: 'JetBrains Mono', monospace; font-size: 13px; color: var(--text-secondary); }
        /* Daily Plan */
        .plan-container { max-width: 800px; }
        .plan-header { display: flex; align-items: center; gap: 12px; margin-bottom: 24px; flex-wrap: wrap; }
        .plan-date { font-size: 20px; font-weight: 600; min-width: 180px; text-align: center; }
        .plan-nav-btn { width: 40px; height: 40px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-card); color: var(--text-primary); font-size: 18px; cursor: pointer; }
        .plan-nav-btn:hover { background: var(--bg-hover); }
        .plan-section { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 20px; margin-bottom: 16px; }
        .plan-section-title { font-size: 14px; font-weight: 600; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
        .plan-notes { width: 100%; min-height: 100px; padding: 14px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-primary); color: var(--text-primary); font-size: 14px; font-family: inherit; resize: vertical; }
        .plan-notes:focus { outline: none; border-color: var(--blue); }
        .tasks-list { margin-bottom: 12px; }
        .task-item { display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 8px; }
        .task-checkbox { width: 20px; height: 20px; cursor: pointer; accent-color: var(--green); }
        .task-text { flex: 1; font-size: 14px; }
        .task-text.completed { text-decoration: line-through; color: var(--text-muted); }
        .task-delete { background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 16px; opacity: 0.5; }
        .task-delete:hover { opacity: 1; color: var(--red); }
        .add-task-row { display: flex; gap: 8px; }
        .add-task-row input { flex: 1; padding: 10px 14px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-primary); color: var(--text-primary); font-size: 14px; }
        .levels-list { margin-bottom: 12px; }
        .level-item { display: flex; align-items: center; gap: 12px; padding: 14px; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 8px; flex-wrap: wrap; }
        .level-ticker { font-weight: 600; font-family: 'JetBrains Mono', monospace; min-width: 60px; }
        .level-prices { display: flex; gap: 8px; flex-wrap: wrap; }
        .level-price { font-family: 'JetBrains Mono', monospace; font-size: 12px; padding: 4px 8px; border-radius: 4px; }
        .level-price.entry { background: var(--blue-dim); color: var(--blue); }
        .level-price.stop { background: var(--red-dim); color: var(--red); }
        .level-price.target { background: var(--green-dim); color: var(--green); }
        .level-note { flex: 1; font-size: 13px; color: var(--text-secondary); min-width: 120px; }
        .level-direction { padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 500; }
        .level-direction.long { background: var(--green-dim); color: var(--green); }
        .level-direction.short { background: var(--red-dim); color: var(--red); }
        .saving-indicator { font-size: 12px; color: var(--yellow); margin-left: 8px; }
        @media (max-width: 768px) {
            .container { padding: 20px 16px; }
            .header { flex-direction: column; align-items: flex-start; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .table-container { overflow-x: auto; }
            table { min-width: 600px; }
            .setup-form { flex-direction: column; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="logo"><div class="logo-icon">üìä</div>Trading Journal</div>
            <div class="header-actions">
                <div class="sync-status"><span class="sync-dot" id="syncDot"></span><span id="syncText">–ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ</span></div>
                <button class="btn btn-secondary btn-icon" onclick="showSetup()">‚öôÔ∏è</button>
                <button class="btn btn-primary" onclick="showAddTrade()">+ –°–¥–µ–ª–∫–∞</button>
            </div>
        </header>

        <div class="setup-banner" id="setupBanner">
            <h3>üîó –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Google Sheets</h3>
            <p>–í—Å—Ç–∞–≤—å URL Google Apps Script</p>
            <div class="setup-form">
                <input type="text" id="scriptUrl" placeholder="https://script.google.com/macros/s/.../exec">
                <button class="btn btn-primary" onclick="connectScript()">–ü–æ–¥–∫–ª—é—á–∏—Ç—å</button>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card"><div class="stat-label">–í—Å–µ–≥–æ —Å–¥–µ–ª–æ–∫</div><div class="stat-value" id="totalTrades">0</div></div>
            <div class="stat-card"><div class="stat-label">Win Rate</div><div class="stat-value" id="winRate">0%</div></div>
            <div class="stat-card"><div class="stat-label">–û–±—â–∏–π P&L</div><div class="stat-value" id="totalPnl">$0</div></div>
            <div class="stat-card"><div class="stat-label">–û—Ç–∫—Ä—ã—Ç—ã–µ</div><div class="stat-value" id="openTrades">0</div></div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('plan')">üìã –ü–ª–∞–Ω</button>
            <button class="tab" onclick="switchTab('open')">–û—Ç–∫—Ä—ã—Ç—ã–µ</button>
            <button class="tab" onclick="switchTab('history')">–ò—Å—Ç–æ—Ä–∏—è</button>
            <button class="tab" onclick="switchTab('stats')">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
            <button class="tab" onclick="switchTab('watchlist')">Watchlist</button>
        </div>

        <!-- Plan Tab -->
        <div class="tab-content active" id="planTab">
            <div class="plan-container">
                <div class="plan-header">
                    <button class="plan-nav-btn" onclick="changeDate(-1)">‚Üê</button>
                    <div class="plan-date" id="planDate"></div>
                    <button class="plan-nav-btn" onclick="changeDate(1)">‚Üí</button>
                    <button class="btn btn-secondary" onclick="goToToday()">–°–µ–≥–æ–¥–Ω—è</button>
                    <span class="saving-indicator" id="savingIndicator"></span>
                </div>
                <div class="plan-section">
                    <h3 class="plan-section-title">üìù –ó–∞–º–µ—Ç–∫–∏ –Ω–∞ –¥–µ–Ω—å</h3>
                    <textarea class="plan-notes" id="dailyNotes" placeholder="–ú—ã—Å–ª–∏, –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ —Ä—ã–Ω–∫–∞, —Å–æ–±—ã—Ç–∏—è..." onchange="saveDailyPlan()"></textarea>
                </div>
                <div class="plan-section">
                    <h3 class="plan-section-title">‚úÖ –ó–∞–¥–∞—á–∏</h3>
                    <div class="tasks-list" id="tasksList"></div>
                    <div class="add-task-row">
                        <input type="text" id="newTaskInput" placeholder="–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞..." onkeypress="if(event.key==='Enter')addTask()">
                        <button class="btn btn-secondary" onclick="addTask()">+</button>
                    </div>
                </div>
                <div class="plan-section">
                    <h3 class="plan-section-title">üìä –£—Ä–æ–≤–Ω–∏ –¥–ª—è —Ç–æ—Ä–≥–æ–≤–ª–∏</h3>
                    <div class="levels-list" id="levelsList"></div>
                    <button class="btn btn-secondary" onclick="showAddLevel()">+ –î–æ–±–∞–≤–∏—Ç—å</button>
                </div>
                <div class="plan-section">
                    <h3 class="plan-section-title">üìà –ò—Ç–æ–≥–∏ –¥–Ω—è</h3>
                    <textarea class="plan-notes" id="dailySummary" placeholder="–ß—Ç–æ —Å–¥–µ–ª–∞–ª, –≤—ã–≤–æ–¥—ã..." onchange="saveDailyPlan()"></textarea>
                </div>
            </div>
        </div>

        <div class="tab-content" id="openTab">
            <div class="table-container">
                <table><thead><tr><th>–¢–∏–∫–µ—Ä</th><th>–¶–µ–Ω–∞</th><th>–ù–∞–ø—Ä.</th><th>–°—Ç–∞—Ç—É—Å</th><th>–í—Ö–æ–¥</th><th>P&L</th><th></th></tr></thead><tbody id="openTradesBody"></tbody></table>
                <div class="empty-state" id="openEmpty"><div class="empty-state-icon">üìà</div><p>–ù–µ—Ç –æ—Ç–∫—Ä—ã—Ç—ã—Ö –ø–æ–∑–∏—Ü–∏–π</p></div>
            </div>
        </div>

        <div class="tab-content" id="historyTab">
            <div class="table-container">
                <table><thead><tr><th>–¢–∏–∫–µ—Ä</th><th>–ù–∞–ø—Ä.</th><th>–°—Ç–∞—Ç—É—Å</th><th>–í—Ö–æ–¥</th><th>–í—ã—Ö–æ–¥</th><th>P&L</th><th></th></tr></thead><tbody id="historyTradesBody"></tbody></table>
                <div class="empty-state" id="historyEmpty"><div class="empty-state-icon">üìú</div><p>–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞</p></div>
            </div>
        </div>

        <div class="tab-content" id="statsTab">
            <div class="stats-section"><h3 class="stats-title">üìä –ü–æ –º–µ—Å—è—Ü–∞–º</h3><div class="monthly-stats" id="monthlyStats"></div></div>
            <div class="stats-section"><h3 class="stats-title">üìà –û–±—â–∞—è</h3><div class="overall-stats" id="overallStats"></div></div>
        </div>

        <div class="tab-content" id="watchlistTab">
            <div style="margin-bottom:16px;"><button class="btn btn-secondary" onclick="showAddWatchlist()">+ –î–æ–±–∞–≤–∏—Ç—å</button></div>
            <div class="table-container">
                <table><thead><tr><th>–¢–∏–∫–µ—Ä</th><th>–¶–µ–Ω–∞</th><th>–ü–æ–¥–¥–µ—Ä–∂–∫–∞</th><th>–°–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏–µ</th><th>–ó–∞–º–µ—Ç–∫–∞</th><th></th></tr></thead><tbody id="watchlistBody"></tbody></table>
                <div class="empty-state" id="watchlistEmpty"><div class="empty-state-icon">üëÄ</div><p>Watchlist –ø—É—Å—Ç</p></div>
            </div>
        </div>
    </div>

    <!-- Trade Modal -->
    <div class="modal-overlay" id="tradeModal">
        <div class="modal">
            <div class="modal-header"><h2 id="tradeModalTitle">–ù–æ–≤–∞—è —Å–¥–µ–ª–∫–∞</h2><button class="modal-close" onclick="closeModal('tradeModal')">√ó</button></div>
            <div class="modal-body">
                <form id="tradeForm" onsubmit="saveTrade(event)">
                    <input type="hidden" id="tradeId">
                    <div class="form-row">
                        <div class="form-group"><label>–¢–∏–∫–µ—Ä</label><div class="autocomplete-wrapper"><input type="text" id="tradeTicker" required placeholder="AAPL" autocomplete="off" onchange="fetchCurrentPrice()"><div class="autocomplete-dropdown" id="tickerDropdown"></div></div></div>
                        <div class="form-group"><label>–¢–µ–∫—É—â–∞—è —Ü–µ–Ω–∞</label><div class="current-price-display"><span class="current-price-value" id="currentPriceValue">‚Äî</span><span class="current-price-change" id="currentPriceChange"></span><button type="button" class="refresh-btn" onclick="fetchCurrentPrice()">üîÑ</button></div></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</label><select id="tradeDirection" onchange="calculateRisk()"><option value="long">Long</option><option value="short">Short</option></select></div>
                        <div class="form-group"><label>–°—Ç–∞—Ç—É—Å</label><select id="tradeStatus" onchange="onStatusChange()"><option value="open">üü° –û—Ç–∫—Ä—ã—Ç–∞</option><option value="partial">üü† –ß–∞—Å—Ç–∏—á–Ω–æ</option><option value="closed">üü¢ –ó–∞–∫—Ä—ã—Ç–∞</option><option value="stopped">üî¥ –°—Ç–æ–ø</option></select></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>–î–∞—Ç–∞ –≤—Ö–æ–¥–∞</label><input type="date" id="tradeEntryDate" required></div>
                        <div class="form-group"><label>–ö–æ–ª-–≤–æ –∞–∫—Ü–∏–π</label><input type="number" id="tradeShares" required placeholder="100" oninput="calculateRisk()"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>–¶–µ–Ω–∞ –≤—Ö–æ–¥–∞</label><input type="number" id="tradeEntryPrice" step="0.01" required placeholder="150.00" oninput="calculateRisk()"></div>
                        <div class="form-group"><label>Stop Loss</label><input type="number" id="tradeStopLoss" step="0.01" placeholder="145.00" oninput="calculateRisk()"></div>
                    </div>
                    <div class="form-row"><div class="form-group"><label>Take Profit</label><input type="number" id="tradeTakeProfit" step="0.01" placeholder="165.00" oninput="calculateRisk()"></div><div class="form-group"></div></div>
                    <div class="risk-calculator"><div class="risk-row"><div class="risk-item loss"><span class="risk-label">–†–∏—Å–∫</span><span class="risk-value" id="riskLoss">‚Äî</span></div><div class="risk-item profit"><span class="risk-label">–ü—Ä–∏–±—ã–ª—å</span><span class="risk-value" id="riskProfit">‚Äî</span></div><div class="risk-item ratio"><span class="risk-label">R/R</span><span class="risk-value" id="riskRatio">‚Äî</span></div></div></div>
                    <div class="exit-fields" id="exitFields" style="display:none;"><div class="form-row"><div class="form-group"><label>–î–∞—Ç–∞ –≤—ã—Ö–æ–¥–∞</label><input type="date" id="tradeExitDate"></div><div class="form-group"><label>–¶–µ–Ω–∞ –≤—ã—Ö–æ–¥–∞</label><input type="number" id="tradeExitPrice" step="0.01" placeholder="160.00"></div></div></div>
                    <div class="form-group"><label>–¢–µ–∑–∏—Å</label><textarea id="tradeThesis" placeholder="–ü–æ—á–µ–º—É –≤–æ—à—ë–ª..."></textarea></div>
                    <div class="form-group" id="exitReasonGroup" style="display:none;"><label>–ü—Ä–∏—á–∏–Ω–∞ –≤—ã—Ö–æ–¥–∞</label><textarea id="tradeExitReason" placeholder="–ü–æ—á–µ–º—É –∑–∞–∫—Ä—ã–ª..."></textarea></div>
                    <div class="form-actions"><button type="button" class="btn btn-secondary" onclick="closeModal('tradeModal')">–û—Ç–º–µ–Ω–∞</button><button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></div>
                </form>
            </div>
        </div>
    </div>

    <!-- Watchlist Modal -->
    <div class="modal-overlay" id="watchlistModal">
        <div class="modal">
            <div class="modal-header"><h2>Watchlist</h2><button class="modal-close" onclick="closeModal('watchlistModal')">√ó</button></div>
            <div class="modal-body">
                <form id="watchlistForm" onsubmit="saveWatchlist(event)">
                    <input type="hidden" id="watchlistId">
                    <div class="form-group"><label>–¢–∏–∫–µ—Ä</label><div class="autocomplete-wrapper"><input type="text" id="watchlistTicker" required placeholder="AAPL" autocomplete="off"><div class="autocomplete-dropdown" id="watchlistTickerDropdown"></div></div></div>
                    <div class="form-row"><div class="form-group"><label>–ü–æ–¥–¥–µ—Ä–∂–∫–∞</label><input type="number" id="watchlistSupport" step="0.01"></div><div class="form-group"><label>–°–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏–µ</label><input type="number" id="watchlistResistance" step="0.01"></div></div>
                    <div class="form-group"><label>–ó–∞–º–µ—Ç–∫–∞</label><textarea id="watchlistNote"></textarea></div>
                    <div class="form-actions"><button type="button" class="btn btn-secondary" onclick="closeModal('watchlistModal')">–û—Ç–º–µ–Ω–∞</button><button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></div>
                </form>
            </div>
        </div>
    </div>

    <!-- Level Modal -->
    <div class="modal-overlay" id="levelModal">
        <div class="modal">
            <div class="modal-header"><h2>–£—Ä–æ–≤–µ–Ω—å</h2><button class="modal-close" onclick="closeModal('levelModal')">√ó</button></div>
            <div class="modal-body">
                <form id="levelForm" onsubmit="saveLevel(event)">
                    <div class="form-row"><div class="form-group"><label>–¢–∏–∫–µ—Ä</label><div class="autocomplete-wrapper"><input type="text" id="levelTicker" required placeholder="AAPL" autocomplete="off"><div class="autocomplete-dropdown" id="levelTickerDropdown"></div></div></div><div class="form-group"><label>–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</label><select id="levelDirection"><option value="long">Long</option><option value="short">Short</option></select></div></div>
                    <div class="form-row"><div class="form-group"><label>–í—Ö–æ–¥</label><input type="number" id="levelEntry" step="0.01"></div><div class="form-group"><label>–°—Ç–æ–ø</label><input type="number" id="levelStop" step="0.01"></div></div>
                    <div class="form-row"><div class="form-group"><label>–¶–µ–ª—å</label><input type="number" id="levelTarget" step="0.01"></div><div class="form-group"></div></div>
                    <div class="form-group"><label>–ó–∞–º–µ—Ç–∫–∞</label><textarea id="levelNote" placeholder="–£—Å–ª–æ–≤–∏–µ –≤—Ö–æ–¥–∞..."></textarea></div>
                    <div class="form-actions"><button type="button" class="btn btn-secondary" onclick="closeModal('levelModal')">–û—Ç–º–µ–Ω–∞</button><button type="submit" class="btn btn-primary">–î–æ–±–∞–≤–∏—Ç—å</button></div>
                </form>
            </div>
        </div>
    </div>

    <script>
        let trades=[], watchlist=[], dailyPlans={}, currentPlanDate=new Date(), scriptUrl=localStorage.getItem('scriptUrl')||'', editingTradeId=null, searchTimeout=null, priceCache={}, planSaveTimeout=null;

        const FINNHUB_KEY='d62cm3pr01qlugephebgd62cm3pr01qlugephec0';
        async function finnhub(endpoint){const r=await fetch(`https://finnhub.io/api/v1/${endpoint}${endpoint.includes('?')?'&':'?'}token=${FINNHUB_KEY}`);if(!r.ok)throw new Error('Finnhub error');return r.json()}

        function setupAutocomplete(iid,did){
            const inp=document.getElementById(iid),dd=document.getElementById(did);
            inp.addEventListener('input',e=>{const q=e.target.value.trim().toUpperCase();if(searchTimeout)clearTimeout(searchTimeout);if(q.length<1){dd.classList.remove('active');return}dd.innerHTML='<div class="autocomplete-loading">...</div>';dd.classList.add('active');searchTimeout=setTimeout(()=>searchTickers(q,dd,inp),300)});
            inp.addEventListener('blur',()=>setTimeout(()=>dd.classList.remove('active'),200));
        }

        async function searchTickers(q,dd,inp){
            try{const d=await finnhub(`search?q=${encodeURIComponent(q)}`);if(d.result?.length){const s=d.result.filter(x=>x.type==='Common Stock'||x.type==='ETP').slice(0,6);if(!s.length){dd.innerHTML='<div class="autocomplete-loading">‚Äî</div>';return}dd.innerHTML=s.map(x=>`<div class="autocomplete-item" data-s="${x.symbol}"><span class="autocomplete-ticker">${x.symbol}</span><span class="autocomplete-name">${x.description||''}</span></div>`).join('');dd.querySelectorAll('.autocomplete-item').forEach(i=>i.addEventListener('mousedown',e=>{e.preventDefault();inp.value=i.dataset.s;dd.classList.remove('active');if(inp.id==='tradeTicker')fetchCurrentPrice()}))}else dd.innerHTML='<div class="autocomplete-loading">‚Äî</div>'}catch{dd.innerHTML='<div class="autocomplete-loading">–û—à–∏–±–∫–∞</div>'}
        }

        document.addEventListener('DOMContentLoaded',()=>{
            setupAutocomplete('tradeTicker','tickerDropdown');
            setupAutocomplete('watchlistTicker','watchlistTickerDropdown');
            setupAutocomplete('levelTicker','levelTickerDropdown');
            initDailyPlan();
            if(scriptUrl){document.getElementById('scriptUrl').value=scriptUrl;loadData()}else showSetup();
        });

        function showSetup(){document.getElementById('setupBanner').classList.add('active')}
        function hideSetup(){document.getElementById('setupBanner').classList.remove('active')}
        async function connectScript(){const u=document.getElementById('scriptUrl').value.trim();if(!u){alert('URL!');return}scriptUrl=u;localStorage.setItem('scriptUrl',u);updateSyncStatus('syncing','...');try{await loadData();hideSetup()}catch{updateSyncStatus('error','–û—à–∏–±–∫–∞');alert('–û—à–∏–±–∫–∞')}}
        function updateSyncStatus(s,t){document.getElementById('syncDot').className='sync-dot '+s;document.getElementById('syncText').textContent=t}

        async function loadData(){
            if(!scriptUrl)return;
            updateSyncStatus('syncing','...');
            try{
                const r=await fetch(`${scriptUrl}?action=getData`);
                const d=await r.json();
                if(d.success){
                    trades=d.trades||[];
                    watchlist=d.watchlist||[];
                    dailyPlans=d.plans||{};
                    renderTrades();renderWatchlist();updateStats();renderDailyPlan();
                    updateSyncStatus('connected','OK');
                    setTimeout(updateTablePrices,500);
                }else throw new Error();
            }catch{updateSyncStatus('error','–û—à–∏–±–∫–∞')}
        }

        async function saveData(type,item,action='add'){
            if(!scriptUrl){alert('–ü–æ–¥–∫–ª—é—á–∏ Sheets');showSetup();return false}
            try{updateSyncStatus('syncing','...');const r=await fetch(`${scriptUrl}?action=${action}&type=${type}&data=${encodeURIComponent(JSON.stringify(item))}`);const d=await r.json();if(d.success){updateSyncStatus('connected','OK');return true}throw new Error()}catch{updateSyncStatus('error','–û—à–∏–±–∫–∞');return false}
        }

        async function deleteData(type,id){
            if(!scriptUrl)return false;
            try{updateSyncStatus('syncing','...');const r=await fetch(`${scriptUrl}?action=delete&type=${type}&id=${id}`);const d=await r.json();if(d.success){updateSyncStatus('connected','OK');return true}throw new Error()}catch{updateSyncStatus('error','–û—à–∏–±–∫–∞');return false}
        }

        function switchTab(t){document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));document.querySelectorAll('.tab-content').forEach(x=>x.classList.remove('active'));event.target.classList.add('active');document.getElementById(t+'Tab').classList.add('active');if(t==='stats')renderStats()}

        // ===== DAILY PLAN (CLOUD SYNC) =====
        function initDailyPlan(){currentPlanDate=new Date();renderDailyPlan()}
        function formatDate(d){const days=['–í—Å','–ü–Ω','–í—Ç','–°—Ä','–ß—Ç','–ü—Ç','–°–±'],mos=['—è–Ω–≤','—Ñ–µ–≤','–º–∞—Ä','–∞–ø—Ä','–º–∞—è','–∏—é–Ω','–∏—é–ª','–∞–≤–≥','—Å–µ–Ω','–æ–∫—Ç','–Ω–æ—è','–¥–µ–∫'];return`${days[d.getDay()]}, ${d.getDate()} ${mos[d.getMonth()]}`}
        function getDateKey(d){return d.toISOString().split('T')[0]}
        function changeDate(delta){currentPlanDate.setDate(currentPlanDate.getDate()+delta);renderDailyPlan()}
        function goToToday(){currentPlanDate=new Date();renderDailyPlan()}

        function renderDailyPlan(){
            document.getElementById('planDate').textContent=formatDate(currentPlanDate);
            const k=getDateKey(currentPlanDate),p=dailyPlans[k]||{notes:'',summary:'',tasks:[],levels:[]};
            document.getElementById('dailyNotes').value=p.notes||'';
            document.getElementById('dailySummary').value=p.summary||'';
            renderTasks(p.tasks||[]);
            renderLevels(p.levels||[]);
        }

        function saveDailyPlan(){
            if(planSaveTimeout)clearTimeout(planSaveTimeout);
            document.getElementById('savingIndicator').textContent='üíæ';
            const k=getDateKey(currentPlanDate);
            if(!dailyPlans[k])dailyPlans[k]={notes:'',summary:'',tasks:[],levels:[]};
            dailyPlans[k].notes=document.getElementById('dailyNotes').value;
            dailyPlans[k].summary=document.getElementById('dailySummary').value;
            planSaveTimeout=setTimeout(()=>syncPlanToCloud(k),1000);
        }

        async function syncPlanToCloud(dateKey){
            if(!scriptUrl){document.getElementById('savingIndicator').textContent='‚ùå';return}
            const plan={date:dateKey,...dailyPlans[dateKey]};
            try{
                const r=await fetch(`${scriptUrl}?action=savePlan&data=${encodeURIComponent(JSON.stringify(plan))}`);
                const d=await r.json();
                document.getElementById('savingIndicator').textContent=d.success?'‚úÖ':'‚ùå';
                setTimeout(()=>document.getElementById('savingIndicator').textContent='',2000);
            }catch{document.getElementById('savingIndicator').textContent='‚ùå'}
        }

        function renderTasks(tasks){
            const c=document.getElementById('tasksList');
            if(!tasks.length){c.innerHTML='<div style="color:var(--text-muted);font-size:13px;padding:8px">–ù–µ—Ç –∑–∞–¥–∞—á</div>';return}
            c.innerHTML=tasks.map((t,i)=>`<div class="task-item"><input type="checkbox" class="task-checkbox" ${t.done?'checked':''} onchange="toggleTask(${i})"><span class="task-text ${t.done?'completed':''}">${t.text}</span><button class="task-delete" onclick="deleteTask(${i})">√ó</button></div>`).join('');
        }

        function addTask(){
            const inp=document.getElementById('newTaskInput'),t=inp.value.trim();if(!t)return;
            const k=getDateKey(currentPlanDate);
            if(!dailyPlans[k])dailyPlans[k]={notes:'',summary:'',tasks:[],levels:[]};
            dailyPlans[k].tasks.push({text:t,done:false});
            inp.value='';renderTasks(dailyPlans[k].tasks);syncPlanToCloud(k);
        }

        function toggleTask(i){
            const k=getDateKey(currentPlanDate);
            if(dailyPlans[k]?.tasks[i]){dailyPlans[k].tasks[i].done=!dailyPlans[k].tasks[i].done;renderTasks(dailyPlans[k].tasks);syncPlanToCloud(k)}
        }

        function deleteTask(i){
            const k=getDateKey(currentPlanDate);
            if(dailyPlans[k]){dailyPlans[k].tasks.splice(i,1);renderTasks(dailyPlans[k].tasks);syncPlanToCloud(k)}
        }

        function renderLevels(levels){
            const c=document.getElementById('levelsList');
            if(!levels.length){c.innerHTML='<div style="color:var(--text-muted);font-size:13px;padding:8px">–ù–µ—Ç —É—Ä–æ–≤–Ω–µ–π</div>';return}
            c.innerHTML=levels.map((l,i)=>`<div class="level-item"><span class="level-ticker">${l.ticker}</span><span class="level-direction ${l.direction}">${l.direction.toUpperCase()}</span><div class="level-prices">${l.entry?`<span class="level-price entry">$${l.entry}</span>`:''}${l.stop?`<span class="level-price stop">$${l.stop}</span>`:''}${l.target?`<span class="level-price target">$${l.target}</span>`:''}</div><span class="level-note">${l.note||''}</span><button class="task-delete" onclick="deleteLevel(${i})">√ó</button></div>`).join('');
        }

        function showAddLevel(){document.getElementById('levelForm').reset();document.getElementById('levelModal').classList.add('active')}

        function saveLevel(e){
            e.preventDefault();
            const l={ticker:document.getElementById('levelTicker').value.toUpperCase(),direction:document.getElementById('levelDirection').value,entry:parseFloat(document.getElementById('levelEntry').value)||0,stop:parseFloat(document.getElementById('levelStop').value)||0,target:parseFloat(document.getElementById('levelTarget').value)||0,note:document.getElementById('levelNote').value};
            const k=getDateKey(currentPlanDate);
            if(!dailyPlans[k])dailyPlans[k]={notes:'',summary:'',tasks:[],levels:[]};
            dailyPlans[k].levels.push(l);renderLevels(dailyPlans[k].levels);syncPlanToCloud(k);closeModal('levelModal');
        }

        function deleteLevel(i){
            const k=getDateKey(currentPlanDate);
            if(dailyPlans[k]){dailyPlans[k].levels.splice(i,1);renderLevels(dailyPlans[k].levels);syncPlanToCloud(k)}
        }

        // ===== TRADES =====
        function calculateRisk(){const dir=document.getElementById('tradeDirection').value,e=parseFloat(document.getElementById('tradeEntryPrice').value)||0,sh=parseInt(document.getElementById('tradeShares').value)||0,sl=parseFloat(document.getElementById('tradeStopLoss').value)||0,tp=parseFloat(document.getElementById('tradeTakeProfit').value)||0;const lE=document.getElementById('riskLoss'),pE=document.getElementById('riskProfit'),rE=document.getElementById('riskRatio');if(!e||!sh){lE.textContent=pE.textContent=rE.textContent='‚Äî';return}let loss=0,profit=0;if(dir==='long'){if(sl>0)loss=(e-sl)*sh;if(tp>0)profit=(tp-e)*sh}else{if(sl>0)loss=(sl-e)*sh;if(tp>0)profit=(e-tp)*sh}lE.textContent=loss>0?`-$${loss.toFixed(0)}`:'‚Äî';pE.textContent=profit>0?`+$${profit.toFixed(0)}`:'‚Äî';if(loss>0&&profit>0){const r=profit/loss;rE.textContent=`1:${r.toFixed(1)}`;rE.style.color=r>=2?'var(--green)':r>=1?'var(--yellow)':'var(--red)'}else{rE.textContent='‚Äî';rE.style.color=''}}
        function onStatusChange(){const s=document.getElementById('tradeStatus').value;document.getElementById('exitFields').style.display=s==='open'?'none':'block';document.getElementById('exitReasonGroup').style.display=s==='open'?'none':'block'}
        function showAddTrade(){editingTradeId=null;document.getElementById('tradeModalTitle').textContent='–ù–æ–≤–∞—è —Å–¥–µ–ª–∫–∞';document.getElementById('tradeForm').reset();document.getElementById('tradeEntryDate').value=new Date().toISOString().split('T')[0];document.getElementById('tradeStatus').value='open';document.getElementById('exitFields').style.display='none';document.getElementById('exitReasonGroup').style.display='none';document.getElementById('riskLoss').textContent=document.getElementById('riskProfit').textContent=document.getElementById('riskRatio').textContent='‚Äî';document.getElementById('currentPriceValue').textContent='‚Äî';document.getElementById('currentPriceChange').textContent='';document.getElementById('tradeModal').classList.add('active')}
        function editTrade(id){const t=trades.find(x=>x.id===id);if(!t)return;editingTradeId=id;document.getElementById('tradeModalTitle').textContent='–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å';document.getElementById('tradeId').value=t.id;document.getElementById('tradeTicker').value=t.ticker;document.getElementById('tradeDirection').value=t.direction;document.getElementById('tradeStatus').value=t.status||'closed';document.getElementById('tradeEntryDate').value=t.entryDate;document.getElementById('tradeExitDate').value=t.exitDate||'';document.getElementById('tradeEntryPrice').value=t.entryPrice;document.getElementById('tradeExitPrice').value=t.exitPrice||'';document.getElementById('tradeShares').value=t.shares;document.getElementById('tradeStopLoss').value=t.stopLoss||'';document.getElementById('tradeTakeProfit').value=t.takeProfit||'';document.getElementById('tradeThesis').value=t.thesis||'';document.getElementById('tradeExitReason').value=t.exitReason||'';const s=t.status||'closed';document.getElementById('exitFields').style.display=s==='open'?'none':'block';document.getElementById('exitReasonGroup').style.display=s==='open'?'none':'block';calculateRisk();fetchCurrentPrice();document.getElementById('tradeModal').classList.add('active')}
        async function saveTrade(e){e.preventDefault();const t={id:editingTradeId||Date.now().toString(),ticker:document.getElementById('tradeTicker').value.toUpperCase(),direction:document.getElementById('tradeDirection').value,status:document.getElementById('tradeStatus').value,entryDate:document.getElementById('tradeEntryDate').value,exitDate:document.getElementById('tradeExitDate').value||'',entryPrice:parseFloat(document.getElementById('tradeEntryPrice').value)||0,exitPrice:parseFloat(document.getElementById('tradeExitPrice').value)||0,shares:parseInt(document.getElementById('tradeShares').value)||0,stopLoss:parseFloat(document.getElementById('tradeStopLoss').value)||0,takeProfit:parseFloat(document.getElementById('tradeTakeProfit').value)||0,thesis:document.getElementById('tradeThesis').value,exitReason:document.getElementById('tradeExitReason').value};if(t.status==='open'){t.exitDate='';t.exitPrice=0;t.exitReason=''}if(await saveData('trade',t,editingTradeId?'update':'add')){if(editingTradeId)trades=trades.map(x=>x.id===t.id?t:x);else trades.push(t);renderTrades();updateStats();closeModal('tradeModal')}}
        async function deleteTrade(id){if(!confirm('–£–¥–∞–ª–∏—Ç—å?'))return;if(await deleteData('trade',id)){trades=trades.filter(x=>x.id!==id);renderTrades();updateStats()}}
        function renderTrades(){renderOpenTrades();renderHistoryTrades()}
        function renderOpenTrades(){const tb=document.getElementById('openTradesBody'),em=document.getElementById('openEmpty'),op=trades.filter(t=>t.status==='open'||t.status==='partial');if(!op.length){tb.innerHTML='';em.style.display='block';return}em.style.display='none';tb.innerHTML=op.map(t=>{const c=priceCache[t.ticker];let ph='...',pnlh='...';if(c){const sg=c.change>=0?'+':'',cl=c.change>=0?'up':'down';ph=`$${c.price.toFixed(2)}<br><span class="price-change ${cl}">${sg}${c.change.toFixed(2)}%</span>`;let pnl=t.direction==='long'?(c.price-t.entryPrice)*t.shares:(t.entryPrice-c.price)*t.shares;const pcl=pnl>=0?'positive':'negative';pnlh=`<span class="pnl ${pcl}">${pnl>=0?'+':''}$${pnl.toFixed(0)}</span>`}return`<tr><td class="ticker">${t.ticker}</td><td class="price-cell">${ph}</td><td><span class="direction ${t.direction}">${t.direction.toUpperCase()}</span></td><td><span class="status ${t.status}">${t.status==='open'?'üü°':'üü†'}</span></td><td>${t.entryDate}<br><span style="color:var(--text-muted)">$${t.entryPrice}</span></td><td>${pnlh}</td><td class="actions"><button class="action-btn" onclick="editTrade('${t.id}')">‚úèÔ∏è</button><button class="action-btn delete" onclick="deleteTrade('${t.id}')">üóëÔ∏è</button></td></tr>`}).join('')}
        function renderHistoryTrades(){const tb=document.getElementById('historyTradesBody'),em=document.getElementById('historyEmpty'),cl=trades.filter(t=>t.status==='closed'||t.status==='stopped');if(!cl.length){tb.innerHTML='';em.style.display='block';return}em.style.display='none';tb.innerHTML=cl.map(t=>{const pnl=calculatePnL(t),cls=pnl>=0?'positive':'negative',ic=t.status==='stopped'?'üî¥':'üü¢';return`<tr><td class="ticker">${t.ticker}</td><td><span class="direction ${t.direction}">${t.direction.toUpperCase()}</span></td><td><span class="status ${t.status}">${ic}</span></td><td>${t.entryDate}<br><span style="color:var(--text-muted)">$${t.entryPrice}</span></td><td>${t.exitDate||'‚Äî'}<br><span style="color:var(--text-muted)">${t.exitPrice?'$'+t.exitPrice:'‚Äî'}</span></td><td class="pnl ${cls}">${pnl>=0?'+':''}$${pnl.toFixed(0)}</td><td class="actions"><button class="action-btn" onclick="editTrade('${t.id}')">‚úèÔ∏è</button><button class="action-btn delete" onclick="deleteTrade('${t.id}')">üóëÔ∏è</button></td></tr>`}).join('')}
        function renderStats(){const mo=document.getElementById('monthlyStats'),ov=document.getElementById('overallStats'),cl=trades.filter(t=>t.status==='closed'||t.status==='stopped');if(!cl.length){mo.innerHTML='<div class="no-stats">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>';ov.innerHTML='';return}const data={};cl.forEach(t=>{const d=t.exitDate||t.entryDate;if(!d)return;const k=d.substring(0,7);if(!data[k])data[k]={pnl:0,trades:0};data[k].pnl+=calculatePnL(t);data[k].trades++});const months=Object.keys(data).sort().reverse(),max=Math.max(...Object.values(data).map(m=>Math.abs(m.pnl)),1),names={'01':'–Ø–Ω–≤','02':'–§–µ–≤','03':'–ú–∞—Ä','04':'–ê–ø—Ä','05':'–ú–∞–π','06':'–ò—é–Ω','07':'–ò—é–ª','08':'–ê–≤–≥','09':'–°–µ–Ω','10':'–û–∫—Ç','11':'–ù–æ—è','12':'–î–µ–∫'};mo.innerHTML=months.map(m=>{const d=data[m],[y,mm]=m.split('-'),pos=d.pnl>=0,w=Math.abs(d.pnl)/max*100;return`<div class="month-row"><span class="month-name">${names[mm]} ${y}</span><div class="month-bar-container"><div class="month-bar ${pos?'positive':'negative'}" style="width:${w}%"></div></div><span class="month-value ${pos?'positive':'negative'}">${pos?'+':''}$${d.pnl.toFixed(0)}</span><span class="month-trades">${d.trades}</span></div>`}).join('');const total=cl.reduce((s,t)=>s+calculatePnL(t),0),wins=cl.filter(t=>calculatePnL(t)>0).length,losses=cl.filter(t=>calculatePnL(t)<0).length,wr=cl.length?wins/cl.length*100:0,avgW=wins?cl.filter(t=>calculatePnL(t)>0).reduce((s,t)=>s+calculatePnL(t),0)/wins:0,avgL=losses?cl.filter(t=>calculatePnL(t)<0).reduce((s,t)=>s+calculatePnL(t),0)/losses:0;ov.innerHTML=`<div class="overall-stat-card"><div class="overall-stat-label">P&L</div><div class="overall-stat-value ${total>=0?'positive':'negative'}">${total>=0?'+':''}$${total.toFixed(0)}</div></div><div class="overall-stat-card"><div class="overall-stat-label">Win Rate</div><div class="overall-stat-value">${wr.toFixed(0)}%</div></div><div class="overall-stat-card"><div class="overall-stat-label">–°–¥–µ–ª–æ–∫</div><div class="overall-stat-value">${cl.length}</div></div><div class="overall-stat-card"><div class="overall-stat-label">–ü—Ä–∏–±—ã–ª—å–Ω—ã—Ö</div><div class="overall-stat-value positive">${wins}</div></div><div class="overall-stat-card"><div class="overall-stat-label">–£–±—ã—Ç–æ—á–Ω—ã—Ö</div><div class="overall-stat-value negative">${losses}</div></div><div class="overall-stat-card"><div class="overall-stat-label">–°—Ä. +</div><div class="overall-stat-value positive">+$${avgW.toFixed(0)}</div></div><div class="overall-stat-card"><div class="overall-stat-label">–°—Ä. -</div><div class="overall-stat-value negative">$${avgL.toFixed(0)}</div></div>`}
        async function fetchCurrentPrice(){const t=document.getElementById('tradeTicker').value.trim().toUpperCase(),pe=document.getElementById('currentPriceValue'),ce=document.getElementById('currentPriceChange');if(!t){pe.textContent='‚Äî';ce.textContent='';return}pe.textContent='...';ce.textContent='';try{const d=await finnhub(`quote?symbol=${t}`);if(d.c>0){pe.textContent='$'+d.c.toFixed(2);if(d.dp!==undefined){ce.textContent=(d.dp>=0?'+':'')+d.dp.toFixed(2)+'%';ce.className='current-price-change '+(d.dp>=0?'up':'down')}}else pe.textContent='‚Äî'}catch{pe.textContent='‚Äî'}}
        async function updateTablePrices(){const tickers=[...new Set(trades.filter(t=>t.status==='open'||t.status==='partial').map(t=>t.ticker))];for(const t of tickers){try{const d=await finnhub(`quote?symbol=${t}`);if(d.c>0){priceCache[t]={price:d.c,change:d.dp||0}}}catch{};await new Promise(r=>setTimeout(r,250))}renderOpenTrades()}
        function calculatePnL(t){if(!t.exitPrice||t.status==='open')return 0;const diff=t.direction==='long'?t.exitPrice-t.entryPrice:t.entryPrice-t.exitPrice;return diff*t.shares}
        function showAddWatchlist(){document.getElementById('watchlistForm').reset();document.getElementById('watchlistId').value='';document.getElementById('watchlistModal').classList.add('active')}
        async function saveWatchlist(e){e.preventDefault();const item={id:document.getElementById('watchlistId').value||Date.now().toString(),ticker:document.getElementById('watchlistTicker').value.toUpperCase(),support:parseFloat(document.getElementById('watchlistSupport').value)||0,resistance:parseFloat(document.getElementById('watchlistResistance').value)||0,note:document.getElementById('watchlistNote').value};const isEdit=!!document.getElementById('watchlistId').value;if(await saveData('watchlist',item,isEdit?'update':'add')){if(isEdit)watchlist=watchlist.map(w=>w.id===item.id?{...w,...item}:w);else watchlist.push(item);renderWatchlist();closeModal('watchlistModal')}}
        async function deleteWatchlistItem(id){if(!confirm('–£–¥–∞–ª–∏—Ç—å?'))return;if(await deleteData('watchlist',id)){watchlist=watchlist.filter(w=>w.id!==id);renderWatchlist()}}
        function renderWatchlist(){const tb=document.getElementById('watchlistBody'),em=document.getElementById('watchlistEmpty');if(!watchlist.length){tb.innerHTML='';em.style.display='block';return}em.style.display='none';tb.innerHTML=watchlist.map(i=>`<tr><td class="ticker">${i.ticker}</td><td>‚Äî</td><td class="level">${i.support?'$'+i.support:'‚Äî'}</td><td class="level">${i.resistance?'$'+i.resistance:'‚Äî'}</td><td style="max-width:200px;overflow:hidden;text-overflow:ellipsis">${i.note||'‚Äî'}</td><td class="actions"><button class="action-btn delete" onclick="deleteWatchlistItem('${i.id}')">üóëÔ∏è</button></td></tr>`).join('')}
        function updateStats(){const cl=trades.filter(t=>t.status!=='open'),pnl=cl.reduce((s,t)=>s+calculatePnL(t),0),wins=cl.filter(t=>calculatePnL(t)>0).length,wr=cl.length?wins/cl.length*100:0,open=trades.filter(t=>t.status==='open').length;document.getElementById('totalTrades').textContent=trades.length;document.getElementById('winRate').textContent=wr.toFixed(0)+'%';const pe=document.getElementById('totalPnl');pe.textContent=(pnl>=0?'+':'')+'$'+pnl.toFixed(0);pe.className='stat-value '+(pnl>=0?'positive':'negative');document.getElementById('openTrades').textContent=open}
        function closeModal(id){document.getElementById(id).classList.remove('active')}
        document.querySelectorAll('.modal-overlay').forEach(o=>o.addEventListener('click',e=>{if(e.target===o)o.classList.remove('active')}));
        document.addEventListener('keydown',e=>{if(e.key==='Escape')document.querySelectorAll('.modal-overlay').forEach(m=>m.classList.remove('active'))});
    </script>
</body>
</html>

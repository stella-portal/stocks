<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Journal | NASDAQ</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0a0c;
            --bg-secondary: #111114;
            --bg-card: #161619;
            --bg-hover: #1c1c20;
            --border: #252529;
            --text-primary: #f4f4f5;
            --text-secondary: #a1a1aa;
            --text-muted: #71717a;
            --green: #22c55e;
            --green-dim: rgba(34, 197, 94, 0.12);
            --red: #ef4444;
            --red-dim: rgba(239, 68, 68, 0.12);
            --blue: #3b82f6;
            --blue-dim: rgba(59, 130, 246, 0.12);
            --yellow: #eab308;
            --yellow-dim: rgba(234, 179, 8, 0.12);
            --purple: #a855f7;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Space Grotesk', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 32px 20px;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
            flex-wrap: wrap;
            gap: 16px;
        }

        .logo {
            font-size: 24px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--green), var(--blue));
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .header-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .sync-status {
            font-size: 13px;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .sync-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--text-muted);
        }

        .sync-dot.connected { background: var(--green); }
        .sync-dot.syncing { background: var(--yellow); animation: pulse 1s infinite; }
        .sync-dot.error { background: var(--red); }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        .btn {
            padding: 10px 18px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
            font-family: inherit;
        }

        .btn-primary {
            background: var(--green);
            color: #000;
        }

        .btn-primary:hover { background: #16a34a; }

        .btn-secondary {
            background: var(--bg-card);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover { background: var(--bg-hover); }

        .btn-icon {
            width: 40px;
            height: 40px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        /* Setup Banner */
        .setup-banner {
            background: linear-gradient(135deg, var(--blue-dim), var(--purple));
            border: 1px solid var(--blue);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
            display: none;
        }

        .setup-banner.active { display: block; }

        .setup-banner h3 {
            font-size: 16px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .setup-banner p {
            color: var(--text-secondary);
            font-size: 14px;
            margin-bottom: 16px;
        }

        .setup-form {
            display: flex;
            gap: 12px;
        }

        .setup-form input {
            flex: 1;
            padding: 10px 14px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 14px;
            font-family: 'JetBrains Mono', monospace;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 12px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
        }

        .stat-label {
            font-size: 12px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 600;
            font-family: 'JetBrains Mono', monospace;
        }

        .stat-value.positive { color: var(--green); }
        .stat-value.negative { color: var(--red); }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 24px;
            background: var(--bg-secondary);
            padding: 4px;
            border-radius: 10px;
            width: fit-content;
        }

        .tab {
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            color: var(--text-secondary);
            background: transparent;
            border: none;
            transition: all 0.2s;
        }

        .tab.active {
            background: var(--bg-card);
            color: var(--text-primary);
        }

        .tab:hover:not(.active) { color: var(--text-primary); }

        /* Tab Content */
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Table */
        .table-container {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 14px 16px;
            text-align: left;
            font-size: 14px;
        }

        th {
            background: var(--bg-secondary);
            color: var(--text-muted);
            font-weight: 500;
            text-transform: uppercase;
            font-size: 11px;
            letter-spacing: 0.5px;
        }

        tr:not(:last-child) td {
            border-bottom: 1px solid var(--border);
        }

        tr:hover td { background: var(--bg-hover); }

        .ticker {
            font-weight: 600;
            font-family: 'JetBrains Mono', monospace;
        }

        .direction {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
        }

        .direction.long {
            background: var(--green-dim);
            color: var(--green);
        }

        .direction.short {
            background: var(--red-dim);
            color: var(--red);
        }

        .status {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
        }

        .status.open {
            background: var(--yellow-dim);
            color: var(--yellow);
        }

        .status.closed {
            background: var(--green-dim);
            color: var(--green);
        }

        .status.stopped {
            background: var(--red-dim);
            color: var(--red);
        }

        .pnl {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 500;
        }

        .pnl.positive { color: var(--green); }
        .pnl.negative { color: var(--red); }

        .actions {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            border: none;
            background: var(--bg-secondary);
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .action-btn:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .action-btn.delete:hover {
            background: var(--red-dim);
            color: var(--red);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-muted);
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 100;
            padding: 20px;
        }

        .modal-overlay.active { display: flex; }

        .modal {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            width: 100%;
            max-width: 480px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            font-size: 18px;
            font-weight: 600;
        }

        .modal-close {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 20px;
        }

        .modal-close:hover { color: var(--text-primary); }

        .modal-body { padding: 24px; }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 14px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 14px;
            font-family: inherit;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .form-actions {
            display: flex;
            gap: 12px;
            padding-top: 8px;
        }

        .form-actions .btn { flex: 1; }

        /* Autocomplete */
        .autocomplete-wrapper {
            position: relative;
        }

        .autocomplete-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-top: 4px;
            max-height: 240px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .autocomplete-dropdown.active {
            display: block;
        }

        .autocomplete-item {
            padding: 10px 14px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
        }

        .autocomplete-item:last-child {
            border-bottom: none;
        }

        .autocomplete-item:hover {
            background: var(--bg-hover);
        }

        .autocomplete-ticker {
            font-weight: 600;
            font-family: 'JetBrains Mono', monospace;
            color: var(--text-primary);
        }

        .autocomplete-name {
            font-size: 12px;
            color: var(--text-muted);
            margin-left: 12px;
            text-align: right;
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .autocomplete-loading {
            padding: 12px;
            text-align: center;
            color: var(--text-muted);
            font-size: 13px;
        }

        /* Risk Calculator */
        .risk-calculator {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 14px;
            margin-bottom: 20px;
        }

        .risk-row {
            display: flex;
            gap: 12px;
        }

        .risk-item {
            flex: 1;
            text-align: center;
            padding: 8px;
            border-radius: 8px;
        }

        .risk-item.loss {
            background: var(--red-dim);
        }

        .risk-item.profit {
            background: var(--green-dim);
        }

        .risk-item.ratio {
            background: var(--blue-dim);
        }

        .risk-label {
            display: block;
            font-size: 11px;
            color: var(--text-muted);
            margin-bottom: 4px;
            text-transform: uppercase;
        }

        .risk-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 14px;
            font-weight: 600;
        }

        .risk-item.loss .risk-value {
            color: var(--red);
        }

        .risk-item.profit .risk-value {
            color: var(--green);
        }

        .risk-item.ratio .risk-value {
            color: var(--blue);
        }

        .exit-fields {
            border-top: 1px solid var(--border);
            padding-top: 20px;
            margin-top: 8px;
        }

        /* Watchlist specific */
        .price-info {
            font-family: 'JetBrains Mono', monospace;
        }

        .price-change {
            font-size: 12px;
            margin-left: 8px;
        }

        .price-change.up { color: var(--green); }
        .price-change.down { color: var(--red); }

        .level {
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
            color: var(--text-secondary);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container { padding: 20px 16px; }
            
            .header { flex-direction: column; align-items: flex-start; }
            
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            
            .table-container { overflow-x: auto; }
            
            table { min-width: 600px; }
            
            .setup-form { flex-direction: column; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="logo">
                <div class="logo-icon">üìä</div>
                Trading Journal
            </div>
            <div class="header-actions">
                <div class="sync-status">
                    <span class="sync-dot" id="syncDot"></span>
                    <span id="syncText">–ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ</span>
                </div>
                <button class="btn btn-secondary btn-icon" onclick="showSetup()" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">‚öôÔ∏è</button>
                <button class="btn btn-primary" onclick="showAddTrade()">+ –°–¥–µ–ª–∫–∞</button>
            </div>
        </header>

        <!-- Setup Banner -->
        <div class="setup-banner" id="setupBanner">
            <h3>üîó –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Google Sheets</h3>
            <p>–í—Å—Ç–∞–≤—å URL —Ç–≤–æ–µ–≥–æ Google Apps Script –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö</p>
            <div class="setup-form">
                <input type="text" id="scriptUrl" placeholder="https://script.google.com/macros/s/.../exec">
                <button class="btn btn-primary" onclick="connectScript()">–ü–æ–¥–∫–ª—é—á–∏—Ç—å</button>
            </div>
        </div>

        <!-- Stats -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">–í—Å–µ–≥–æ —Å–¥–µ–ª–æ–∫</div>
                <div class="stat-value" id="totalTrades">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Win Rate</div>
                <div class="stat-value" id="winRate">0%</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">–û–±—â–∏–π P&L</div>
                <div class="stat-value" id="totalPnl">$0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">–û—Ç–∫—Ä—ã—Ç—ã–µ</div>
                <div class="stat-value" id="openTrades">0</div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('trades')">–°–¥–µ–ª–∫–∏</button>
            <button class="tab" onclick="switchTab('watchlist')">Watchlist</button>
        </div>

        <!-- Trades Tab -->
        <div class="tab-content active" id="tradesTab">
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>–¢–∏–∫–µ—Ä</th>
                            <th>–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</th>
                            <th>–°—Ç–∞—Ç—É—Å</th>
                            <th>–í—Ö–æ–¥</th>
                            <th>–í—ã—Ö–æ–¥</th>
                            <th>P&L</th>
                            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>
                    <tbody id="tradesBody"></tbody>
                </table>
                <div class="empty-state" id="tradesEmpty">
                    <div class="empty-state-icon">üìà</div>
                    <p>–ü–æ–∫–∞ –Ω–µ—Ç —Å–¥–µ–ª–æ–∫. –î–æ–±–∞–≤—å –ø–µ—Ä–≤—É—é!</p>
                </div>
            </div>
        </div>

        <!-- Watchlist Tab -->
        <div class="tab-content" id="watchlistTab">
            <div style="margin-bottom: 16px;">
                <button class="btn btn-secondary" onclick="showAddWatchlist()">+ –î–æ–±–∞–≤–∏—Ç—å –≤ Watchlist</button>
            </div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>–¢–∏–∫–µ—Ä</th>
                            <th>–¶–µ–Ω–∞</th>
                            <th>–ü–æ–¥–¥–µ—Ä–∂–∫–∞</th>
                            <th>–°–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏–µ</th>
                            <th>–ó–∞–º–µ—Ç–∫–∞</th>
                            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>
                    <tbody id="watchlistBody"></tbody>
                </table>
                <div class="empty-state" id="watchlistEmpty">
                    <div class="empty-state-icon">üëÄ</div>
                    <p>Watchlist –ø—É—Å—Ç. –î–æ–±–∞–≤—å –∞–∫—Ü–∏–∏ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è!</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Trade Modal -->
    <div class="modal-overlay" id="tradeModal">
        <div class="modal">
            <div class="modal-header">
                <h2 id="tradeModalTitle">–ù–æ–≤–∞—è —Å–¥–µ–ª–∫–∞</h2>
                <button class="modal-close" onclick="closeModal('tradeModal')">√ó</button>
            </div>
            <div class="modal-body">
                <form id="tradeForm" onsubmit="saveTrade(event)">
                    <input type="hidden" id="tradeId">
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>–¢–∏–∫–µ—Ä</label>
                            <div class="autocomplete-wrapper">
                                <input type="text" id="tradeTicker" required placeholder="–ù–∞—á–Ω–∏ –≤–≤–æ–¥–∏—Ç—å..." autocomplete="off">
                                <div class="autocomplete-dropdown" id="tickerDropdown"></div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</label>
                            <select id="tradeDirection">
                                <option value="long">Long</option>
                                <option value="short">Short</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>–°—Ç–∞—Ç—É—Å</label>
                        <select id="tradeStatus" onchange="onStatusChange()">
                            <option value="open">üü° –û—Ç–∫—Ä—ã—Ç–∞</option>
                            <option value="partial">üü† –ß–∞—Å—Ç–∏—á–Ω–æ –∑–∞–∫—Ä—ã—Ç–∞</option>
                            <option value="closed">üü¢ –ó–∞–∫—Ä—ã—Ç–∞</option>
                            <option value="stopped">üî¥ –°—Ç–æ–ø</option>
                        </select>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>–î–∞—Ç–∞ –≤—Ö–æ–¥–∞</label>
                            <input type="date" id="tradeEntryDate" required>
                        </div>
                        <div class="form-group">
                            <label>–î–∞—Ç–∞ –≤—ã—Ö–æ–¥–∞</label>
                            <input type="date" id="tradeExitDate">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>–¶–µ–Ω–∞ –≤—Ö–æ–¥–∞</label>
                            <input type="number" id="tradeEntryPrice" step="0.01" required placeholder="150.00" oninput="calculateRisk()">
                        </div>
                        <div class="form-group">
                            <label>–ö–æ–ª-–≤–æ –∞–∫—Ü–∏–π</label>
                            <input type="number" id="tradeShares" required placeholder="100" oninput="calculateRisk()">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Stop Loss</label>
                            <input type="number" id="tradeStopLoss" step="0.01" placeholder="145.00" oninput="calculateRisk()">
                        </div>
                        <div class="form-group">
                            <label>Take Profit</label>
                            <input type="number" id="tradeTakeProfit" step="0.01" placeholder="165.00" oninput="calculateRisk()">
                        </div>
                    </div>

                    <!-- Risk/Reward Calculator -->
                    <div class="risk-calculator" id="riskCalculator">
                        <div class="risk-row">
                            <div class="risk-item loss">
                                <span class="risk-label">–†–∏—Å–∫ (SL)</span>
                                <span class="risk-value" id="riskLoss">‚Äî</span>
                            </div>
                            <div class="risk-item profit">
                                <span class="risk-label">–ü—Ä–∏–±—ã–ª—å (TP)</span>
                                <span class="risk-value" id="riskProfit">‚Äî</span>
                            </div>
                            <div class="risk-item ratio">
                                <span class="risk-label">R/R</span>
                                <span class="risk-value" id="riskRatio">‚Äî</span>
                            </div>
                        </div>
                    </div>

                    <!-- Exit fields - shown only when status is not "open" -->
                    <div class="exit-fields" id="exitFields" style="display: none;">
                        <div class="form-row">
                            <div class="form-group">
                                <label>–î–∞—Ç–∞ –≤—ã—Ö–æ–¥–∞</label>
                                <input type="date" id="tradeExitDate">
                            </div>
                            <div class="form-group">
                                <label>–¶–µ–Ω–∞ –≤—ã—Ö–æ–¥–∞</label>
                                <input type="number" id="tradeExitPrice" step="0.01" placeholder="160.00">
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>–¢–µ–∑–∏—Å (–ø–æ—á–µ–º—É –≤–æ—à—ë–ª)</label>
                        <textarea id="tradeThesis" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –∏–¥–µ–∏..."></textarea>
                    </div>

                    <div class="form-group" id="exitReasonGroup" style="display: none;">
                        <label>–ü—Ä–∏—á–∏–Ω–∞ –≤—ã—Ö–æ–¥–∞</label>
                        <textarea id="tradeExitReason" placeholder="–ü–æ—á–µ–º—É –∑–∞–∫—Ä—ã–ª –ø–æ–∑–∏—Ü–∏—é..."></textarea>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('tradeModal')">–û—Ç–º–µ–Ω–∞</button>
                        <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Add Watchlist Modal -->
    <div class="modal-overlay" id="watchlistModal">
        <div class="modal">
            <div class="modal-header">
                <h2>–î–æ–±–∞–≤–∏—Ç—å –≤ Watchlist</h2>
                <button class="modal-close" onclick="closeModal('watchlistModal')">√ó</button>
            </div>
            <div class="modal-body">
                <form id="watchlistForm" onsubmit="saveWatchlist(event)">
                    <input type="hidden" id="watchlistId">
                    
                    <div class="form-group">
                        <label>–¢–∏–∫–µ—Ä</label>
                        <div class="autocomplete-wrapper">
                            <input type="text" id="watchlistTicker" required placeholder="–ù–∞—á–Ω–∏ –≤–≤–æ–¥–∏—Ç—å..." autocomplete="off">
                            <div class="autocomplete-dropdown" id="watchlistTickerDropdown"></div>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>–ü–æ–¥–¥–µ—Ä–∂–∫–∞</label>
                            <input type="number" id="watchlistSupport" step="0.01" placeholder="450.00">
                        </div>
                        <div class="form-group">
                            <label>–°–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏–µ</label>
                            <input type="number" id="watchlistResistance" step="0.01" placeholder="500.00">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>–ó–∞–º–µ—Ç–∫–∞</label>
                        <textarea id="watchlistNote" placeholder="–ù–∞ —á—Ç–æ –æ–±—Ä–∞—Ç–∏—Ç—å –≤–Ω–∏–º–∞–Ω–∏–µ..."></textarea>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('watchlistModal')">–û—Ç–º–µ–Ω–∞</button>
                        <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // State
        let trades = [];
        let watchlist = [];
        let scriptUrl = localStorage.getItem('scriptUrl') || '';
        let editingTradeId = null;
        let searchTimeout = null;

        // Ticker Autocomplete
        function setupAutocomplete(inputId, dropdownId) {
            const input = document.getElementById(inputId);
            const dropdown = document.getElementById(dropdownId);

            input.addEventListener('input', (e) => {
                const query = e.target.value.trim();
                
                if (searchTimeout) clearTimeout(searchTimeout);
                
                if (query.length < 1) {
                    dropdown.classList.remove('active');
                    return;
                }

                dropdown.innerHTML = '<div class="autocomplete-loading">–ü–æ–∏—Å–∫...</div>';
                dropdown.classList.add('active');

                searchTimeout = setTimeout(() => searchTickers(query, dropdown, input), 300);
            });

            input.addEventListener('blur', () => {
                setTimeout(() => dropdown.classList.remove('active'), 200);
            });

            input.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    dropdown.classList.remove('active');
                }
            });
        }

        async function searchTickers(query, dropdown, input) {
            try {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º corsproxy.io –¥–ª—è –æ–±—Ö–æ–¥–∞ CORS
                const yahooUrl = `https://query1.finance.yahoo.com/v1/finance/search?q=${encodeURIComponent(query)}&quotesCount=8&newsCount=0&enableFuzzyQuery=false&quotesQueryId=tss_match_phrase_query`;
                const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(yahooUrl)}`;
                
                const response = await fetch(proxyUrl);
                const data = await response.json();

                if (data.quotes && data.quotes.length > 0) {
                    const stocks = data.quotes.filter(q => 
                        q.quoteType === 'EQUITY' || q.quoteType === 'ETF'
                    ).slice(0, 6);

                    if (stocks.length === 0) {
                        dropdown.innerHTML = '<div class="autocomplete-loading">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
                        return;
                    }

                    dropdown.innerHTML = stocks.map(stock => `
                        <div class="autocomplete-item" data-symbol="${stock.symbol}">
                            <span class="autocomplete-ticker">${stock.symbol}</span>
                            <span class="autocomplete-name">${stock.shortname || stock.longname || ''}</span>
                        </div>
                    `).join('');

                    dropdown.querySelectorAll('.autocomplete-item').forEach(item => {
                        item.addEventListener('mousedown', (e) => {
                            e.preventDefault();
                            input.value = item.dataset.symbol;
                            dropdown.classList.remove('active');
                        });
                    });
                } else {
                    dropdown.innerHTML = '<div class="autocomplete-loading">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
                }
            } catch (error) {
                console.error('Search error:', error);
                dropdown.innerHTML = '<div class="autocomplete-loading">–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞</div>';
            }
        }

        // Init
        document.addEventListener('DOMContentLoaded', () => {
            // Setup autocomplete for ticker inputs
            setupAutocomplete('tradeTicker', 'tickerDropdown');
            setupAutocomplete('watchlistTicker', 'watchlistTickerDropdown');

            if (scriptUrl) {
                document.getElementById('scriptUrl').value = scriptUrl;
                loadData();
            } else {
                showSetup();
            }
        });

        // Setup
        function showSetup() {
            document.getElementById('setupBanner').classList.add('active');
        }

        function hideSetup() {
            document.getElementById('setupBanner').classList.remove('active');
        }

        async function connectScript() {
            const url = document.getElementById('scriptUrl').value.trim();
            if (!url) {
                alert('–í—Å—Ç–∞–≤—å URL —Å–∫—Ä–∏–ø—Ç–∞');
                return;
            }

            scriptUrl = url;
            localStorage.setItem('scriptUrl', url);
            updateSyncStatus('syncing', '–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...');

            try {
                await loadData();
                hideSetup();
            } catch (e) {
                updateSyncStatus('error', '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è');
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è. –ü—Ä–æ–≤–µ—Ä—å URL.');
            }
        }

        function updateSyncStatus(status, text) {
            const dot = document.getElementById('syncDot');
            const txt = document.getElementById('syncText');
            dot.className = 'sync-dot ' + status;
            txt.textContent = text;
        }

        // Data Loading
        async function loadData() {
            if (!scriptUrl) return;

            updateSyncStatus('syncing', '–ó–∞–≥—Ä—É–∑–∫–∞...');

            try {
                const response = await fetch(`${scriptUrl}?action=getData`);
                const data = await response.json();

                if (data.success) {
                    trades = data.trades || [];
                    watchlist = data.watchlist || [];
                    renderTrades();
                    renderWatchlist();
                    updateStats();
                    updateSyncStatus('connected', '–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ');
                } else {
                    throw new Error(data.error);
                }
            } catch (e) {
                console.error('Load error:', e);
                updateSyncStatus('error', '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏');
            }
        }

        // Save Data
        async function saveData(type, item, action = 'add') {
            if (!scriptUrl) {
                alert('–°–Ω–∞—á–∞–ª–∞ –ø–æ–¥–∫–ª—é—á–∏ Google Sheets');
                showSetup();
                return false;
            }

            try {
                updateSyncStatus('syncing', '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...');

                const params = new URLSearchParams({
                    action: action,
                    type: type,
                    data: JSON.stringify(item)
                });

                const response = await fetch(`${scriptUrl}?${params.toString()}`);
                const result = await response.json();

                if (result.success) {
                    updateSyncStatus('connected', '–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ');
                    return true;
                } else {
                    throw new Error(result.error);
                }
            } catch (e) {
                console.error('Save error:', e);
                updateSyncStatus('error', '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
                return false;
            }
        }

        async function deleteData(type, id) {
            if (!scriptUrl) return false;

            try {
                updateSyncStatus('syncing', '–£–¥–∞–ª–µ–Ω–∏–µ...');

                const params = new URLSearchParams({
                    action: 'delete',
                    type: type,
                    id: id
                });

                const response = await fetch(`${scriptUrl}?${params.toString()}`);
                const result = await response.json();

                if (result.success) {
                    updateSyncStatus('connected', '–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ');
                    return true;
                } else {
                    throw new Error(result.error);
                }
            } catch (e) {
                console.error('Delete error:', e);
                updateSyncStatus('error', '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
                return false;
            }
        }

        // Tabs
        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tab + 'Tab').classList.add('active');
        }

        // Risk Calculator
        function calculateRisk() {
            const direction = document.getElementById('tradeDirection').value;
            const entryPrice = parseFloat(document.getElementById('tradeEntryPrice').value) || 0;
            const shares = parseInt(document.getElementById('tradeShares').value) || 0;
            const stopLoss = parseFloat(document.getElementById('tradeStopLoss').value) || 0;
            const takeProfit = parseFloat(document.getElementById('tradeTakeProfit').value) || 0;

            const riskLossEl = document.getElementById('riskLoss');
            const riskProfitEl = document.getElementById('riskProfit');
            const riskRatioEl = document.getElementById('riskRatio');

            if (!entryPrice || !shares) {
                riskLossEl.textContent = '‚Äî';
                riskProfitEl.textContent = '‚Äî';
                riskRatioEl.textContent = '‚Äî';
                return;
            }

            let potentialLoss = 0;
            let potentialProfit = 0;

            if (direction === 'long') {
                if (stopLoss > 0) {
                    potentialLoss = (entryPrice - stopLoss) * shares;
                }
                if (takeProfit > 0) {
                    potentialProfit = (takeProfit - entryPrice) * shares;
                }
            } else {
                // Short
                if (stopLoss > 0) {
                    potentialLoss = (stopLoss - entryPrice) * shares;
                }
                if (takeProfit > 0) {
                    potentialProfit = (entryPrice - takeProfit) * shares;
                }
            }

            riskLossEl.textContent = potentialLoss > 0 ? `-$${potentialLoss.toFixed(0)}` : '‚Äî';
            riskProfitEl.textContent = potentialProfit > 0 ? `+$${potentialProfit.toFixed(0)}` : '‚Äî';

            if (potentialLoss > 0 && potentialProfit > 0) {
                const ratio = potentialProfit / potentialLoss;
                riskRatioEl.textContent = `1:${ratio.toFixed(1)}`;
                riskRatioEl.style.color = ratio >= 2 ? 'var(--green)' : ratio >= 1 ? 'var(--yellow)' : 'var(--red)';
            } else {
                riskRatioEl.textContent = '‚Äî';
                riskRatioEl.style.color = '';
            }
        }

        // Status Change Handler
        function onStatusChange() {
            const status = document.getElementById('tradeStatus').value;
            const exitFields = document.getElementById('exitFields');
            const exitReasonGroup = document.getElementById('exitReasonGroup');

            if (status === 'open') {
                exitFields.style.display = 'none';
                exitReasonGroup.style.display = 'none';
            } else {
                exitFields.style.display = 'block';
                exitReasonGroup.style.display = 'block';
            }
        }

        // Trades
        function showAddTrade() {
            editingTradeId = null;
            document.getElementById('tradeModalTitle').textContent = '–ù–æ–≤–∞—è —Å–¥–µ–ª–∫–∞';
            document.getElementById('tradeForm').reset();
            document.getElementById('tradeEntryDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('tradeStatus').value = 'open';
            document.getElementById('exitFields').style.display = 'none';
            document.getElementById('exitReasonGroup').style.display = 'none';
            document.getElementById('riskLoss').textContent = '‚Äî';
            document.getElementById('riskProfit').textContent = '‚Äî';
            document.getElementById('riskRatio').textContent = '‚Äî';
            document.getElementById('tradeModal').classList.add('active');
        }

        function editTrade(id) {
            const trade = trades.find(t => t.id === id);
            if (!trade) return;

            editingTradeId = id;
            document.getElementById('tradeModalTitle').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–¥–µ–ª–∫—É';
            document.getElementById('tradeId').value = trade.id;
            document.getElementById('tradeTicker').value = trade.ticker;
            document.getElementById('tradeDirection').value = trade.direction;
            document.getElementById('tradeStatus').value = trade.status || 'closed';
            document.getElementById('tradeEntryDate').value = trade.entryDate;
            document.getElementById('tradeExitDate').value = trade.exitDate || '';
            document.getElementById('tradeEntryPrice').value = trade.entryPrice;
            document.getElementById('tradeExitPrice').value = trade.exitPrice || '';
            document.getElementById('tradeShares').value = trade.shares;
            document.getElementById('tradeStopLoss').value = trade.stopLoss || '';
            document.getElementById('tradeTakeProfit').value = trade.takeProfit || '';
            document.getElementById('tradeThesis').value = trade.thesis || '';
            document.getElementById('tradeExitReason').value = trade.exitReason || '';
            
            // Show/hide exit fields based on status
            const status = trade.status || 'closed';
            if (status === 'open') {
                document.getElementById('exitFields').style.display = 'none';
                document.getElementById('exitReasonGroup').style.display = 'none';
            } else {
                document.getElementById('exitFields').style.display = 'block';
                document.getElementById('exitReasonGroup').style.display = 'block';
            }
            
            calculateRisk();
            document.getElementById('tradeModal').classList.add('active');
        }

        async function saveTrade(e) {
            e.preventDefault();

            const trade = {
                id: editingTradeId || Date.now().toString(),
                ticker: document.getElementById('tradeTicker').value.toUpperCase(),
                direction: document.getElementById('tradeDirection').value,
                status: document.getElementById('tradeStatus').value,
                entryDate: document.getElementById('tradeEntryDate').value,
                exitDate: document.getElementById('tradeExitDate').value || '',
                entryPrice: parseFloat(document.getElementById('tradeEntryPrice').value) || 0,
                exitPrice: parseFloat(document.getElementById('tradeExitPrice').value) || 0,
                shares: parseInt(document.getElementById('tradeShares').value) || 0,
                stopLoss: parseFloat(document.getElementById('tradeStopLoss').value) || 0,
                takeProfit: parseFloat(document.getElementById('tradeTakeProfit').value) || 0,
                thesis: document.getElementById('tradeThesis').value,
                exitReason: document.getElementById('tradeExitReason').value
            };

            // Clear exit data if status is open
            if (trade.status === 'open') {
                trade.exitDate = '';
                trade.exitPrice = 0;
                trade.exitReason = '';
            }

            const action = editingTradeId ? 'update' : 'add';
            const success = await saveData('trade', trade, action);

            if (success) {
                if (editingTradeId) {
                    trades = trades.map(t => t.id === trade.id ? trade : t);
                } else {
                    trades.push(trade);
                }
                renderTrades();
                updateStats();
                closeModal('tradeModal');
            }
        }

        async function deleteTrade(id) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å —Å–¥–µ–ª–∫—É?')) return;

            const success = await deleteData('trade', id);
            if (success) {
                trades = trades.filter(t => t.id !== id);
                renderTrades();
                updateStats();
            }
        }

        function renderTrades() {
            const tbody = document.getElementById('tradesBody');
            const empty = document.getElementById('tradesEmpty');

            if (trades.length === 0) {
                tbody.innerHTML = '';
                empty.style.display = 'block';
                return;
            }

            empty.style.display = 'none';
            tbody.innerHTML = trades.map(trade => {
                const pnl = calculatePnL(trade);
                const pnlClass = pnl >= 0 ? 'positive' : 'negative';
                const statusClass = trade.status || 'closed';
                const statusLabels = {
                    open: 'üü° –û—Ç–∫—Ä—ã—Ç–∞',
                    partial: 'üü† –ß–∞—Å—Ç–∏—á–Ω–æ',
                    closed: 'üü¢ –ó–∞–∫—Ä—ã—Ç–∞',
                    stopped: 'üî¥ –°—Ç–æ–ø'
                };

                return `
                    <tr>
                        <td class="ticker">${trade.ticker}</td>
                        <td><span class="direction ${trade.direction}">${trade.direction.toUpperCase()}</span></td>
                        <td><span class="status ${statusClass}">${statusLabels[statusClass] || statusLabels.closed}</span></td>
                        <td>${trade.entryDate}<br><span style="color:var(--text-muted)">$${trade.entryPrice}</span></td>
                        <td>${trade.exitDate || '‚Äî'}<br><span style="color:var(--text-muted)">${trade.exitPrice ? '$' + trade.exitPrice : '‚Äî'}</span></td>
                        <td class="pnl ${pnlClass}">${pnl >= 0 ? '+' : ''}$${pnl.toFixed(2)}</td>
                        <td class="actions">
                            <button class="action-btn" onclick="editTrade('${trade.id}')" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">‚úèÔ∏è</button>
                            <button class="action-btn delete" onclick="deleteTrade('${trade.id}')" title="–£–¥–∞–ª–∏—Ç—å">üóëÔ∏è</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Add event listener for direction change to recalculate risk
        document.getElementById('tradeDirection').addEventListener('change', calculateRisk);

        function calculatePnL(trade) {
            if (!trade.exitPrice || trade.status === 'open') return 0;
            
            const diff = trade.direction === 'long' 
                ? trade.exitPrice - trade.entryPrice
                : trade.entryPrice - trade.exitPrice;
            
            return diff * trade.shares;
        }

        // Watchlist
        function showAddWatchlist() {
            document.getElementById('watchlistForm').reset();
            document.getElementById('watchlistId').value = '';
            document.getElementById('watchlistModal').classList.add('active');
        }

        async function saveWatchlist(e) {
            e.preventDefault();

            const item = {
                id: document.getElementById('watchlistId').value || Date.now().toString(),
                ticker: document.getElementById('watchlistTicker').value.toUpperCase(),
                support: parseFloat(document.getElementById('watchlistSupport').value) || 0,
                resistance: parseFloat(document.getElementById('watchlistResistance').value) || 0,
                note: document.getElementById('watchlistNote').value
            };

            const isEdit = !!document.getElementById('watchlistId').value;
            const success = await saveData('watchlist', item, isEdit ? 'update' : 'add');

            if (success) {
                if (isEdit) {
                    watchlist = watchlist.map(w => w.id === item.id ? {...w, ...item} : w);
                } else {
                    watchlist.push(item);
                }
                renderWatchlist();
                closeModal('watchlistModal');
            }
        }

        async function deleteWatchlistItem(id) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å –∏–∑ watchlist?')) return;

            const success = await deleteData('watchlist', id);
            if (success) {
                watchlist = watchlist.filter(w => w.id !== id);
                renderWatchlist();
            }
        }

        function renderWatchlist() {
            const tbody = document.getElementById('watchlistBody');
            const empty = document.getElementById('watchlistEmpty');

            if (watchlist.length === 0) {
                tbody.innerHTML = '';
                empty.style.display = 'block';
                return;
            }

            empty.style.display = 'none';
            tbody.innerHTML = watchlist.map(item => {
                const changeClass = (item.priceChange || 0) >= 0 ? 'up' : 'down';
                const changeSign = (item.priceChange || 0) >= 0 ? '+' : '';

                return `
                    <tr>
                        <td class="ticker">${item.ticker}</td>
                        <td class="price-info">
                            ${item.currentPrice ? '$' + item.currentPrice.toFixed(2) : '‚Äî'}
                            ${item.priceChange ? `<span class="price-change ${changeClass}">${changeSign}${item.priceChange.toFixed(2)}%</span>` : ''}
                        </td>
                        <td class="level">${item.support ? '$' + item.support : '‚Äî'}</td>
                        <td class="level">${item.resistance ? '$' + item.resistance : '‚Äî'}</td>
                        <td style="max-width:200px;overflow:hidden;text-overflow:ellipsis">${item.note || '‚Äî'}</td>
                        <td class="actions">
                            <button class="action-btn delete" onclick="deleteWatchlistItem('${item.id}')" title="–£–¥–∞–ª–∏—Ç—å">üóëÔ∏è</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Stats
        function updateStats() {
            const closedTrades = trades.filter(t => t.status !== 'open');
            const totalPnl = closedTrades.reduce((sum, t) => sum + calculatePnL(t), 0);
            const wins = closedTrades.filter(t => calculatePnL(t) > 0).length;
            const winRate = closedTrades.length > 0 ? (wins / closedTrades.length * 100) : 0;
            const openCount = trades.filter(t => t.status === 'open').length;

            document.getElementById('totalTrades').textContent = trades.length;
            document.getElementById('winRate').textContent = winRate.toFixed(0) + '%';
            
            const pnlEl = document.getElementById('totalPnl');
            pnlEl.textContent = (totalPnl >= 0 ? '+' : '') + '$' + totalPnl.toFixed(2);
            pnlEl.className = 'stat-value ' + (totalPnl >= 0 ? 'positive' : 'negative');

            document.getElementById('openTrades').textContent = openCount;
        }

        // Modal
        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
        }

        // Close on escape/overlay click
        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    overlay.classList.remove('active');
                }
            });
        });

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('active'));
            }
        });
    </script>
</body>
</html>
